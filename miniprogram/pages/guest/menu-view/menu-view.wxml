<!--pages/guest/menu-view/menu-view.wxml-->
<wxs src="../../../utils/array.wxs" module="arrayUtils" />

<view class="container">
  <view class="table-header card" wx:if="{{tableInfo}}">
    <text class="table-name">{{tableInfo.name}}</text>
    <text class="table-time" wx:if="{{tableInfo.diningDate}}">{{tableInfo.diningDate}} {{tableInfo.diningTime}}</text>
  </view>

  <view class="menu-tabs">
    <view class="tab-item {{currentCategory === 'all' ? 'active' : ''}}" bindtap="switchCategory" data-category="all">
      å…¨éƒ¨
    </view>
    <view class="tab-item {{currentCategory === item ? 'active' : ''}}" wx:for="{{categories}}" wx:key="*this" bindtap="switchCategory" data-category="{{item}}">
      {{item}}
    </view>
  </view>

  <view class="dish-list">
    <view class="dish-item card" wx:for="{{filteredDishes}}" wx:key="id">
      <image class="dish-image" src="{{item.image || '/images/default-dish.png'}}" mode="aspectFill"></image>
      <view class="dish-info">
        <view class="dish-header">
          <text class="dish-name">{{item.name}}</text>
          <text class="status-tag recommended" wx:if="{{item.status === 'recommended'}}">æ¨è</text>
          <text class="status-tag soldout" wx:if="{{item.status === 'soldout'}}">å”®ç½„</text>
        </view>
        <text class="dish-desc">{{item.description}}</text>
        <view class="dish-footer">
          <text class="dish-price">Â¥{{item.price}}</text>
          <view class="quantity-control" wx:if="{{item.status !== 'soldout'}}">
            <text class="quantity-btn" bindtap="decreaseQuantity" data-id="{{item.id}}">-</text>
            <text class="quantity-number">{{item.myQuantity || 0}}</text>
            <text class="quantity-btn" bindtap="increaseQuantity" data-id="{{item.id}}">+</text>
          </view>
        </view>
        <view class="dish-note" wx:if="{{myOrders[item.id] && myOrders[item.id].note}}">
          <text class="note-text">å¤‡æ³¨ï¼š{{myOrders[item.id].note}}</text>
          <text class="note-edit" bindtap="openNoteModal" data-id="{{item.id}}">ç¼–è¾‘</text>
        </view>
        <view class="dish-note-add" wx:if="{{item.myQuantity > 0 && (!myOrders[item.id] || !myOrders[item.id].note)}}">
          <text class="note-add-btn" bindtap="openNoteModal" data-id="{{item.id}}">+ æ·»åŠ å¤‡æ³¨</text>
        </view>
        <view class="dish-total" wx:if="{{item.totalQuantity > 0}}">
          <text>å…± {{item.totalQuantity}} ä»½</text>
        </view>
      </view>
    </view>
  </view>

  <view class="empty-state" wx:if="{{filteredDishes.length === 0}}">
    <view class="empty-icon">ğŸ½ï¸</view>
    <text class="empty-text">æš‚æ— èœå“</text>
  </view>

  <view class="bottom-bar">
    <view class="cart-info" bindtap="viewMyOrders">
      <text class="cart-text">æˆ‘çš„ç‚¹èœ</text>
      <text class="cart-count">{{myTotalQuantity}}</text>
    </view>
    <button class="btn-primary" bindtap="viewAllOrders">æŸ¥çœ‹å…¨éƒ¨</button>
  </view>
</view>

<!-- å¤‡æ³¨å¼¹çª— -->
<view class="modal {{showNoteModal ? 'show' : ''}}" bindtap="closeNoteModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ å¤‡æ³¨</text>
      <text class="modal-close" bindtap="closeNoteModal">Ã—</text>
    </view>
    <view class="modal-body">
      <!-- å¸¸è§é€‰é¡¹ -->
      <view class="note-options">
        <text class="option-label">å¸¸è§é€‰é¡¹ï¼š</text>
        <view class="option-tags">
          <text 
            class="option-tag {{arrayUtils.includes(selectedNoteOptions, item) ? 'selected' : ''}}"
            wx:for="{{noteOptions}}"
            wx:key="*this"
            bindtap="toggleNoteOption"
            data-option="{{item}}"
          >
            {{item}}
          </text>
        </view>
      </view>
      <!-- è‡ªç”±æ–‡æœ¬ -->
      <view class="note-textarea">
        <text class="textarea-label">å…¶ä»–å¤‡æ³¨ï¼š</text>
        <textarea 
          class="textarea-field" 
          placeholder="è¯·è¾“å…¥å…¶ä»–å¤‡æ³¨ä¿¡æ¯" 
          value="{{noteText}}" 
          bindinput="onNoteInput" 
          maxlength="50" 
        />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-secondary" bindtap="closeNoteModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="saveNote">ä¿å­˜</button>
    </view>
  </view>
</view>

