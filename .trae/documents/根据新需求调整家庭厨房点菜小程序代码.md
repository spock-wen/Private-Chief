# 家庭厨房点菜小程序调整方案

## 1. 数据库调整

### 1.1 修改 users 集合
- 添加 `avatarUrl` 和 `nickName` 字段，存储用户头像和昵称
- 调整角色逻辑：支持多个主人，主人不可取消身份（第一个主人）

### 1.2 调整 menus 集合
- 修改 `status` 字段可选值为：`available`（可点）、`recommended`（推荐）、`soldout`（售罄）

### 1.3 优化 tables 集合
- 确保 `createdBy` 字段正确关联创建者

### 1.4 移除 tableDishes 集合
- 菜单与饭桌不再绑定，所有饭桌可访问全量菜单

## 2. 云函数调整

### 2.1 优化 loginUser 云函数
- 调用微信授权接口，获取用户头像和昵称
- 首次登录生成唯一用户码
- 处理首次创建饭桌自动成为主人的逻辑

### 2.2 升级 createTable 云函数
- 添加返回饭桌二维码功能
- 确保首次创建者自动成为主人（不可取消）

### 2.3 添加 getTables 云函数
- 支持主人获取自己创建的所有饭桌
- 实现分页功能（每页10个）
- 按创建时间倒序排列

### 2.4 调整菜单相关云函数
- addDish：支持菜品图片上传和缩略图生成
- updateDish：支持修改菜品状态
- getMenu：返回全量菜单，支持按分类筛选

### 2.5 优化点菜相关云函数
- orderDish：支持同一用户对同一菜品多次修改数量
- updateOrder：完善点菜记录更新功能

### 2.6 增强 confirmMenu 云函数
- 锁定菜单，防止继续点菜

## 3. 前端调整

### 3.1 调整 app.js
- 实现微信授权登录逻辑
- 支持游客模式浏览菜单
- 完善全局状态管理

### 3.2 页面调整
- 饭桌列表页面：添加分页功能，显示所有饭桌
- 菜单页面：支持分类Tab（热菜、冷菜、汤品、酒水）
- 个人中心页面：显示是否为主人，支持主人取消身份（非第一个主人）

### 3.3 实现 WebSocket 实时同步
- 用于实时更新点菜记录和菜单状态

## 4. 技术配置

### 4.1 配置 ESLint + Prettier
- 确保所有代码通过ESLint检查
- 实现代码自动格式化

### 4.2 配置云存储
- 支持菜品图片上传（JPG/PNG，最大2MB）
- 实现自动生成缩略图功能

## 5. 角色功能调整

### 5.1 主人端
- 支持创建饭桌，自动成为主人
- 管理全局菜单
- 查看所有饭桌（分页）
- 确认最终菜单

### 5.2 客人端
- 扫码进入饭桌
- 登录后可点菜
- 查看自己和所有人的点菜记录

## 6. 实现步骤

1. 调整数据库结构
2. 修改登录相关云函数
3. 优化饭桌管理云函数
4. 调整菜单管理云函数
5. 完善点菜功能云函数
6. 实现前端页面调整
7. 配置 ESLint + Prettier
8. 测试所有功能

以上方案将确保小程序按照新需求实现，同时保持代码的可维护性和性能。